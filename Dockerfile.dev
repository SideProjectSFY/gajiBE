FROM eclipse-temurin:17-jdk
WORKDIR /app

# Copy Gradle wrapper and configuration files
COPY build.gradle settings.gradle gradle.properties gradlew ./
COPY gradle ./gradle

# Fix line endings (CRLF to LF) and make gradlew executable
RUN tr -d '\r' < ./gradlew > ./gradlew.tmp && mv ./gradlew.tmp ./gradlew && chmod +x ./gradlew

# Download dependencies (cached layer)
RUN bash ./gradlew dependencies --no-daemon

# Copy source code
COPY src ./src

# Copy and setup entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh && \
    sed -i 's/\r$//' /entrypoint.sh || true

# Use entrypoint to fix gradlew line endings at runtime
ENTRYPOINT ["/entrypoint.sh"]

# Run Spring Boot with DevTools
CMD ["bash", "./gradlew", "bootRun", "--no-daemon"]
