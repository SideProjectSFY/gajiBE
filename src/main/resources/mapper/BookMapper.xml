<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gaji.corebackend.mapper.BookMapper">

    <!-- Result Map for Book with aggregated counts -->
    <resultMap id="BookResultMap" type="com.gaji.corebackend.entity.Book">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="author" column="author"/>
        <result property="genre" column="genre"/>
        <result property="coverImageUrl" column="cover_image_url"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="scenarioCount" column="scenario_count"/>
        <result property="conversationCount" column="conversation_count"/>
        <result property="likeCount" column="like_count"/>
    </resultMap>

    <!-- Find books with pagination, filtering, and sorting -->
    <select id="findBooks" resultMap="BookResultMap">
        SELECT
            n.id,
            n.title,
            n.author,
            n.genre,
            n.cover_image_url,
            n.created_at,
            n.updated_at,
            COALESCE(n.like_count, 0) as like_count,
            COUNT(DISTINCT s.id) as scenario_count,
            COALESCE(SUM(
                (SELECT COUNT(*) FROM conversations c WHERE c.scenario_id = s.id)
            ), 0) as conversation_count
        FROM novels n
        LEFT JOIN scenarios s ON s.novel_id = n.id
        <where>
            <if test="genre != null and genre != ''">
                AND n.genre = #{genre}
            </if>
        </where>
        GROUP BY n.id, n.title, n.author, n.genre, n.cover_image_url, n.created_at, n.updated_at, n.like_count
        <choose>
            <when test="sort == 'scenarios'">
                ORDER BY scenario_count DESC, n.title ASC
            </when>
            <when test="sort == 'conversations'">
                ORDER BY conversation_count DESC, n.title ASC
            </when>
            <when test="sort == 'newest'">
                ORDER BY n.created_at DESC, n.title ASC
            </when>
            <when test="sort == 'alphabetical'">
                ORDER BY n.title ASC
            </when>
            <otherwise>
                ORDER BY scenario_count DESC, n.title ASC
            </otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count total books for pagination -->
    <select id="countBooks" resultType="int">
        SELECT COUNT(*)
        FROM novels n
        <where>
            <if test="genre != null and genre != ''">
                AND n.genre = #{genre}
            </if>
        </where>
    </select>

    <!-- Find book by ID with aggregated counts -->
    <select id="findBookById" resultMap="BookResultMap">
        SELECT
            n.id,
            n.title,
            n.author,
            n.genre,
            n.cover_image_url,
            n.created_at,
            n.updated_at,
            COALESCE(n.like_count, 0) as like_count,
            COUNT(DISTINCT s.id) as scenario_count,
            COALESCE(SUM(
                (SELECT COUNT(*) FROM conversations c WHERE c.scenario_id = s.id)
            ), 0) as conversation_count
        FROM novels n
        LEFT JOIN scenarios s ON s.novel_id = n.id
        WHERE n.id = #{id}
        GROUP BY n.id, n.title, n.author, n.genre, n.cover_image_url, n.created_at, n.updated_at, n.like_count
    </select>

</mapper>
