<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gaji.corebackend.mapper.UserFollowMapper">

    <resultMap id="UserResultMap" type="com.gaji.corebackend.entity.User">
        <id property="id" column="id"/>
        <result property="email" column="email"/>
        <result property="username" column="username"/>
        <result property="passwordHash" column="password_hash"/>
        <result property="bio" column="bio"/>
        <result property="avatarUrl" column="avatar_url"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="role" column="role"/>
        <result property="isActive" column="is_active"/>
        <result property="lastLoginAt" column="last_login_at"/>
    </resultMap>

    <select id="existsByFollowerIdAndFolloweeId" resultType="boolean">
        SELECT EXISTS(SELECT 1 FROM user_follows WHERE follower_id = #{followerId} AND followee_id = #{followeeId})
    </select>

    <delete id="deleteByFollowerIdAndFolloweeId">
        DELETE FROM user_follows WHERE follower_id = #{followerId} AND followee_id = #{followeeId}
    </delete>

    <select id="countByFolloweeId" resultType="long">
        SELECT COUNT(*) FROM user_follows WHERE followee_id = #{followeeId}
    </select>

    <select id="countByFollowerId" resultType="long">
        SELECT COUNT(*) FROM user_follows WHERE follower_id = #{followerId}
    </select>

    <select id="findFollowersByUserId" resultMap="UserResultMap">
        SELECT u.* 
        FROM users u
        JOIN user_follows f ON u.id = f.follower_id
        WHERE f.followee_id = #{userId}
        ORDER BY f.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="findFollowingByUserId" resultMap="UserResultMap">
        SELECT u.* 
        FROM users u
        JOIN user_follows f ON u.id = f.followee_id
        WHERE f.follower_id = #{userId}
        ORDER BY f.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <insert id="insert" parameterType="com.gaji.corebackend.entity.UserFollow">
        INSERT INTO user_follows (
            follower_id, followee_id, created_at
        ) VALUES (
            #{followerId}, #{followeeId}, NOW()
        )
    </insert>

</mapper>
